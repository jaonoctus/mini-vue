<html>
  <head></head>
  <body>
    <div id="app"></div>

    <script>
      let activeEffect = null

      class Dep {
        subscribers = new Set()

        depend () {
          if (activeEffect) {
            this.subscribers.add(activeEffect)
          }
        }

        notify () {
          this.subscribers.forEach((effect) => {
            effect()
          })
        }
      }

      function watchEffect(effect) {
        activeEffect = effect
        effect()
        activeEffect = null
      }

      const dep = new Dep()

      // function reactive (raw) {
      //   Object.keys(raw).forEach((key) => {
      //     const dep = new Dep()
      //     let value = raw[key]

      //     Object.defineProperty(raw, key, {
      //       get () {
      //         dep.depend()
      //         return value
      //       },
      //       set (newValue) {
      //         value = newValue
      //         dep.notify()
      //       }
      //     })
      //   })

      //   return raw
      // }

      /**
       * https://developer.mozilla.org/pt-BR/docs/Web/JavaScript/Reference/Global_Objects/WeakMap
       *
       * The target is always a object.
       * WeakMap can only use object as keys
       *
       * If the target object itself becomes no longer accessable from any code,
       * this target can be garbage collected.
       */
      const targetMap = new WeakMap()

      function getDep (target, key) {
        let depsMap = targetMap.get(target)

        if (!depsMap) {
          depsMap = new Map()

          targetMap.set(target, depsMap)
        }

        let dep = depsMap.get(key)

        if (!dep) {
          dep = new Dep()

          depsMap.set(key, dep)
        }

        return dep
      }

      const reactiveHandlers = {
        get (target, key, receiver) {
          const dep = getDep(target, key)

          dep.depend()

          // return target[key]
          return Reflect.get(target, key, receiver)
        },
        set (target, key, value, receiver) {
          const dep = getDep(target, key)

          const result = Reflect.set(target, key, value, receiver)

          dep.notify()

          return result
        }
      }

      function reactive (raw) {
        return new Proxy(raw, reactiveHandlers)
      }

      watchEffect(() => {
        console.log('effect run', dep.value)
      })

      const state = reactive({
        count: 0
      })

      watchEffect(() => {
        console.log(state.count)
      })

      state.count++
    </script>
  </body>
</html>
